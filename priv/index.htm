<!-- See LICENSE for licensing information. -->
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>ICE computings visualiser</title>
    <script src="/rsc/jquery.min-1.7.2.js"></script>
    <script src="/static/bullet.js"></script>
    <script type="text/javascript">
    $(document).ready(function(){
        var eons = [];
        var name = 'Icy';
        var bullet;

        var open = function(){
            bullet = $.bullet('ws://localhost:8888/bullet');

            bullet.onopen = function(){
                $('#status').text('online').css({backgroundColor: 'green'});
            };
            bullet.ondisconnect = function(){
                $('#status').text('offline').css({backgroundColor: 'red'});
            };
            bullet.onclose = function(){
                $('#status').text('closed').css({backgroundColor: 'yellow'});
            };

            bullet.onheartbeat = function(){
                console.log('ping: ' + name);
                bullet.send('ping: ' + name);
            };

            // onmessage
            bullet.onmessage = function(e){
                if (e.data != 'pong'){
                    var pre = $('#msg');
                    var obj = EON(e.data);
                    eons.push(obj);
                    pre.text(pre.text() + JSON.stringify(obj) + '\n');
                }
            };
        };

        open();

        $('.enable').on('click', function(){
            if (bullet == null){
                open();
            } else {
                bullet.close();
                bullet = null;
            }
        });

        $('#tree').on('click', function(){
            console.log(eons);
            var pre = $('#msg');
            if (pre.text() == ''){
                eons.forEach(function(eon){
                    pre.text(pre.text() + JSON.stringify(obj) + '\n');
                });
            } else {
                var tree = TREE_threads(eons);
                alert(tree);
                pre.text('');
            }
        });
    });

    var EON = function(e_string) {
        var obj = $.parseJSON(eval(e_string));
        console.log('RECV: ' + JSON.stringify(obj));
        return {name: obj["Erlang"]["Tuple"].shift(), data: obj["Erlang"]["Tuple"]};
    };

    var TREE_threads = function(eons){
        var isntrs = {};
        eons.forEach(function(eon){
            if (isntrs[eon.name] === null){
                isntrs[eon.name] = [];
            }
            isntrs[eon.name].push(eon.data);
        });
        var root = {data: {type: "ROOT", word: isntrs["tcore"].shift()}, children: []};


    };
    </script>
</head>

<body>
    <p>
        <button id="status" class="enable" style="background-color:cyan;">unknown</button>
        <button id="tree" style="float:right;">Toggle tree</button>
    </p>

    <hr style="clear:both;"/>

    <table width="100%" height="100%">
        <tbody>
            <tr>
                <td align="center" valign="middle">
<pre id="msg">
Events recap:
</pre>
                </td>
            </tr>
        </tbody>
    </table>
</body>
</html>

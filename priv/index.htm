<!-- See LICENSE for licensing information. -->
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>ICE computings visualiser</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

    <link rel="stylesheet" type="text/css" href="rsc/jquery-ui-1.9.2.custom.css"/>
    <link rel="stylesheet" type="text/css" href="rsc/font-awesome.min.css"/>

    <link rel="stylesheet" type="text/css" href="rsc/bootstrap.min.css"/>
    <link rel="stylesheet" type="text/css" href="rsc/dagre-d3-simple.css"/>
    <link rel="stylesheet" type="text/css" href="rsc/digraph.css"/>

    <script type="text/javascript" src="rsc/jquery-2.0.0.min.js"></script>
    <script type="text/javascript" src="rsc/jquery.form.min.js"></script>
    <script type="text/javascript" src="rsc/d3.min.js"></script>
    <script type="text/javascript" src="rsc/dagre.min.js"></script>
    <script type="text/javascript" src="rsc/dagre-d3-simple.js"></script>

    <script type="text/javascript" src="rsc/tree.json"></script>

    <script src="/static/bullet.js"></script>
    <script type="text/javascript">
    $(document).ready(function(){
        var eons = [];
        var name = 'Icy';
        var bullet;

        var open = function(){
            bullet = $.bullet('ws://localhost:8888/bullet');

            bullet.onopen = function(){
                $('#status').text('online').css({backgroundColor: 'green'});
            };
            bullet.ondisconnect = function(){
                $('#status').text('offline').css({backgroundColor: 'red'});
            };
            bullet.onclose = function(){
                $('#status').text('closed').css({backgroundColor: 'yellow'});
            };

            bullet.onheartbeat = function(){
                console.log('ping: ' + name);
                bullet.send('ping: ' + name);
            };

            // onmessage
            bullet.onmessage = function(e){
                if (e.data != 'pong'){
                    var pre = $('#msg');
                    var obj = EON(e.data);
                    eons.push(obj);
                    pre.text(pre.text() + JSON.stringify(obj) + '\n');
                }
            };
        };

        open();

        $('.enable').on('click', function(){
            if (bullet == null){
                open();
            } else {
                bullet.close();
                bullet = null;
            }
        });

        $('#tree').on('click', function(){
            console.log(eons);
            var pre = $('#msg');
            var tre = $('#attach');
            if (false === pre.is(':visible')){
                tre.toggle();
                pre.toggle();
            } else {
                tre.toggle();
                pre.toggle();
                renderText();
                //var tree = TREE_threads(eons);
                //alert(tree);
            }
        });
        $('#attach').toggle(false);

    });

    var EON = function(e_string) {
        var obj = $.parseJSON(eval(e_string));
        console.log('RECV: ' + JSON.stringify(obj));
        return {name: obj["Erlang"]["Tuple"].shift(), data: obj["Erlang"]["Tuple"]};
    };

    var TREE_threads = function(eons){
        var isntrs = {};
        eons.forEach(function(eon){
            if (isntrs[eon.name] === null){
                isntrs[eon.name] = [];
            }
            isntrs[eon.name].push(eon.data);
        });
        var root = {data: {type: "ROOT", word: isntrs["tcore"].shift()}, children: []};


    };
    </script>

    <style type="text/css">
    header { background-color:lightgreen; text-align:center; height:30px; }
    header > button#status { float:left; height:30px; background-color:cyan; }
    header > button#tree { float:right; height:30px; }
    </style>

</head>
<body>

    <header>
        <button id="status" class="enable">unknown</button>
        <span>I was blind but now Icy!</span>
        <button id="tree">Toggle tree</button>
    </header>

    <table width="100%" height="100%">
        <tbody>
            <tr>
                <td align="center" valign="middle">
<pre id="msg">
Events recap:
</pre>
                </td>
            </tr>
        </tbody>
    </table>

    <script type="text/javascript" src="rsc/make_tree.js"></script>
    <div id="attach">
        <svg class="main-svg" id="svg-canvas"></svg>
    </div>

</body>
</html>
